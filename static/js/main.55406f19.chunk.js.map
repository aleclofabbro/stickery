{"version":3,"sources":["lib/utils.ts","ui/templates/Main.tsx","ui/elements/basic/Button.tsx","ui/elements/top-bar/Button.tsx","ui/modules/Modal/Modal.tsx","lib/hook/useNavStack.ts","ui/modules/top-bar/AddStickerButton.tsx","lib/importImage.ts","srv/db/index.ts","hoc/modules/importedImageGallery/ImportedImageGalleryHOC.tsx","lib/hook/useFileChooser.tsx","srv/fabric/canvas.tsx","lib/hook/useBoolState.ts","hoc/modules/top-bar/AddStickerButtonHoc.tsx","ui/modules/top-bar/SetBgButton.tsx","hoc/modules/top-bar/SetBgButtonHoc.tsx","hoc/canvas/MainCanvasHoc.tsx","state/project/reducer.ts","state/project/index.tsx","index.tsx","ctx/globs.tsx","hoc/App.tsx"],"names":["k","MainTpl","Canvas","TopBar","style","outerStyle","topBarStyle","canvasStyle","display","gridTemplate","gridArea","backgroundColor","Button","onClick","children","TopBarButton","btnStyle","float","Modal","onClickOut","ref","useRef","useEffect","current","div","parent","parentElement","document","body","appendChild","onBack","back","window","history","pushState","_onBack","addEventListener","removeEventListener","useMemo","bgClick","useCallback","ev","target","currentTarget","id","bgStyle","modalStyle","position","left","top","right","bottom","AddStickerButton","closeModal","isModalOpen","openModal","Gallery","getImageSrcUrl","name","stickeryDB","imageData","imageMeta","version","stores","table","Dexie","importFile","file","a","async","arrayBuffer","imgData","blob","add","imgMeta","size","lastModified","type","src","Promise","resolve","GridGallery","require","ImportedImageGalleryHOC","onClickImage","useState","images","setImagesMeta","toArray","then","creating","_primKey","newImageMeta","_tx","creatingHook","hook","subscribe","unsubscribe","useImagesStore","fileChoosen","onFileChoosen","inputRef","chooseFile","click","input","createElement","setAttribute","changeListener","files","length","removeChild","pasteListener","pasteEv","data","clipboardData","dropListener","dragEv","dataTransfer","useFileChooser","gridImages","map","meta","thumbnail","thumbnailWidth","thumbnailHeight","select","this","props","item","templateStyle","headStyle","galleryContainerStyle","gridConfig","onClickThumbnail","enableImageSelection","overflowY","overflowX","FabricCanvasCtx","createContext","FabricCanvasCtrl","FabricCanvasCtxProvider","setState","canvas","setCanvas","ctl","setBackground","url","fabric","Image","fromURL","img","setBackgroundImage","resizeCanvas","toDatalessJSON","addSticker","scaleToWidth","innerWidth","ctx","Provider","value","useCanvasCtrl","useContext","dim","height","innerHeight","width","setDimensions","bgImg","backgroundImage","setZoom","renderAll","bgImage","zoom","Math","min","canvasOpts","interactive","FabricCanvas","opts","canvasRef","resizeHandler","throttle","trailing","canvasElem","useBoolState","initial","state","toFalse","toTrue","toggle","b","T","F","t","s","AddStickerButtonHoc","mainCanvasCtrl","imageSelected","SetBgButton","SetBgButtonHoc","MainCanvasHoc","mainCanvasStyle","reducer","prev","action","_reducer","p","v","initialState","background","ProjectStateCtx","ProvideProjectState","useReducer","dispatch","ReactDOM","render","mainProps","console","log","getElementById","navigator","serviceWorker","register"],"mappings":"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","file":"static/js/main.55406f19.chunk.js","sourcesContent":["export type Setter<S, K extends keyof S> = (key: K) => (state: S, v: S[K]) => S\nexport const setter = <S, K extends keyof S>(k: K) => (state: S, v: S[K]): S => ({\n  ...state,\n  [k]: v\n})\n","import React, { CSSProperties, SFC } from 'react'\n\nexport interface MainTpl {\n  TopBar: JSX.Element\n  Canvas: JSX.Element\n}\nexport const MainTpl: SFC<MainTpl> = ({ Canvas, TopBar }) => {\n  return (\n    <div style={outerStyle}>\n      <div style={topBarStyle}>{TopBar}</div>\n      <div style={canvasStyle}>{Canvas}</div>\n    </div>\n  )\n}\nconst outerStyle: CSSProperties = {\n  display: 'grid',\n  gridTemplate: `\n  \"top-bar\" 20px\n  \"canvas\" auto\n  `\n}\nconst topBarStyle: CSSProperties = {\n  gridArea: 'top-bar',\n  backgroundColor: '#262626'\n}\nconst canvasStyle: CSSProperties = {\n  gridArea: 'canvas',\n  backgroundColor: '#1a1a1a'\n}\n","import React, { SFC, CSSProperties } from 'react'\n\nexport interface Button {\n  onClick(): unknown\n  style?: CSSProperties\n}\n\nexport const Button: SFC<Button> = ({ onClick, style, children }) => {\n  return (\n    <button onClick={onClick} style={style}>\n      {children}\n    </button>\n  )\n}\n","import React, { SFC, CSSProperties } from 'react'\nimport { Button } from '../basic/Button'\n\nexport interface TopBarButton {\n  onClick(): unknown\n}\nexport const TopBarButton: SFC<TopBarButton> = ({ onClick, children }) => {\n  return (\n    <Button style={btnStyle} onClick={onClick}>\n      {children}\n    </Button>\n  )\n}\nconst btnStyle: CSSProperties = {\n  float: 'left',\n  backgroundColor: 'gray'\n}\n","import React, { CSSProperties, SFC, useRef, useEffect, useCallback } from 'react'\nimport { useNavStack } from '../../../lib/hook/useNavStack'\n\nexport interface Modal {\n  onClickOut(): unknown\n}\nexport const Modal: SFC<Modal> = ({ onClickOut, children }) => {\n  const ref = useRef<HTMLDivElement>(null)\n\n  useEffect(() => {\n    if (ref.current) {\n      const div = ref.current\n      const parent = ref.current.parentElement\n      document.body.appendChild(div)\n      return () => {\n        parent && parent.appendChild(div)\n      }\n    }\n  }, [])\n  const { back } = useNavStack(onClickOut)\n  const bgClick = useCallback(\n    (ev: React.MouseEvent<HTMLDivElement>) => {\n      if (ev.target !== ev.currentTarget) {\n        return\n      } else {\n        back()\n        onClickOut()\n      }\n    },\n    [onClickOut, back]\n  )\n\n  return (\n    <div id=\"modal\" ref={ref} style={bgStyle} onClick={bgClick}>\n      <div style={modalStyle}>{children}</div>\n    </div>\n  )\n}\nconst modalStyle: CSSProperties = {\n  position: 'fixed',\n  left: '5%',\n  top: '5%',\n  right: '5%',\n  bottom: '5%',\n  backgroundColor: '#1a1a1a'\n}\nconst bgStyle: CSSProperties = {\n  position: 'fixed',\n  left: 0,\n  top: 0,\n  right: 0,\n  bottom: 0,\n  backgroundColor: 'rgba(255, 255, 255, 0.7)'\n}\n","import { useEffect, useMemo } from 'react'\n\nexport const useNavStack = (onBack: () => unknown) => {\n  useEffect(() => {\n    window.history.pushState({}, '')\n    const _onBack = () => {\n      onBack()\n    }\n    window.addEventListener('popstate', _onBack)\n    return () => {\n      window.removeEventListener('popstate', _onBack)\n      // window.history.back()\n    }\n  }, [onBack])\n  return useMemo(() => {\n    return {\n      back: () => {\n        window.history.back()\n      }\n    }\n  }, [])\n}\n","import React, { SFC } from 'react'\nimport { TopBarButton } from '../../elements/top-bar/Button'\nimport { Modal } from '../Modal/Modal'\n\nexport interface AddStickerButton {\n  isModalOpen: boolean\n  openModal(): unknown\n  closeModal(): unknown\n  Gallery: JSX.Element\n}\n\nexport const AddStickerButton: SFC<AddStickerButton> = ({\n  closeModal,\n  isModalOpen,\n  openModal,\n  Gallery\n}) => {\n  return (\n    <>\n      <TopBarButton onClick={openModal}>Sticker</TopBarButton>\n      {isModalOpen && <Modal onClickOut={closeModal}>{Gallery}</Modal>}\n    </>\n  )\n}\n","export const getImageSrcUrl = (name: string, id: number) => `/_/images/${id}/${name}`\n","import Dexie from 'dexie'\nimport { useEffect, useMemo, useState } from 'react'\nimport { getImageSrcUrl } from '../../lib/importImage'\n\nexport interface ImageData {\n  id?: number\n  blob: Blob\n}\nexport interface ImageMeta {\n  id: number\n  name: string\n  type: string\n  size: number\n  lastModified: number\n  src: string\n}\n\nclass StickeryDatabase extends Dexie {\n  imageData: Dexie.Table<ImageData, number>\n  imageMeta: Dexie.Table<ImageMeta, number>\n\n  constructor() {\n    super('Stickery')\n    this.version(1).stores({\n      imageData: '++id, blob',\n      imageMeta: 'id,src, name, type, size, lastModified'\n    })\n    this.imageData = this.table('imageData')\n    this.imageMeta = this.table('imageMeta')\n  }\n}\nexport const stickeryDB = new StickeryDatabase()\n\nexport const useImagesStore = () => {\n  const [images, setImagesMeta] = useState<ImageMeta[]>([])\n  useEffect(() => {\n    stickeryDB.imageMeta.toArray().then(setImagesMeta)\n  }, [])\n  useEffect(() => {\n    const creating = (_primKey: string, newImageMeta: ImageMeta, _tx: Dexie.Transaction) => {\n      setImagesMeta([newImageMeta, ...images])\n    }\n    const creatingHook = stickeryDB.imageMeta.hook('creating')\n    creatingHook.subscribe(creating)\n    return () => {\n      creatingHook.unsubscribe(creating)\n    }\n  }, [images])\n  return useMemo(() => {\n    return { images, add: importFile }\n  }, [images])\n}\n\nexport const importFile = async (file: File): Promise<ImageMeta> => {\n  const imgData: ImageData = {\n    //@ts-ignore\n    blob: await file.arrayBuffer()\n  }\n  const id = await stickeryDB.imageData.add(imgData)\n  const imgMeta: ImageMeta = {\n    size: file.size,\n    lastModified: file.lastModified,\n    name: file.name,\n    type: file.type,\n    src: getImageSrcUrl(file.name, id),\n    id\n  }\n  await stickeryDB.imageMeta.add(imgMeta)\n  return Promise.resolve(imgMeta)\n}\n","import React, { SFC, useCallback, useMemo, CSSProperties } from 'react'\nimport { ImageMeta, useImagesStore } from '../../../srv/db'\nimport { Button } from '../../../ui/elements/basic/Button'\nimport { useFileChooser } from '../../../lib/hook/useFileChooser'\nconst GridGallery = require('react-grid-gallery')\nexport interface Image {\n  src: string\n  thumbnail: string\n  thumbnailWidth: number\n  thumbnailHeight: number\n}\nexport interface ImportedImageGalleryHOC {\n  onClickImage(meta: ImageMeta): unknown\n}\nexport const ImportedImageGalleryHOC: SFC<ImportedImageGalleryHOC> = ({ onClickImage }) => {\n  const { images, add } = useImagesStore()\n  const [importFile] = useFileChooser({ onFileChoosen: add })\n\n  const gridImages = useMemo<Image[]>(\n    () =>\n      images.map((imgMeta) => {\n        return {\n          meta: imgMeta,\n          src: imgMeta.src,\n          thumbnail: imgMeta.src,\n          thumbnailWidth: 0,\n          thumbnailHeight: 0\n        }\n      }),\n    [images]\n  )\n\n  const select = useCallback(\n    function(this: { props: { item: { meta: ImageMeta } } }) {\n      onClickImage(this.props.item.meta)\n    },\n    [onClickImage]\n  )\n  return (\n    <div style={templateStyle}>\n      <div style={headStyle}>\n        <Button onClick={importFile}>scegli file</Button>\n        <br />\n        <span>o incolla</span>\n      </div>\n      <div style={galleryContainerStyle}>\n        <GridGallery {...gridConfig} images={gridImages} onClickThumbnail={select} />\n      </div>\n    </div>\n  )\n}\n\nconst gridConfig = {\n  enableImageSelection: false\n}\n\nconst templateStyle: CSSProperties = {\n  display: 'grid',\n  gridTemplate: `\n  \"head\" 20px\n  \"gallery\" auto\n  `,\n  position: 'absolute',\n  top: 0,\n  bottom: 0\n}\n\nconst headStyle: CSSProperties = {\n  gridArea: 'head'\n}\n\nconst galleryContainerStyle: CSSProperties = {\n  gridArea: 'gallery',\n  overflowY: 'auto',\n  overflowX: 'hidden'\n}\n","import { useCallback, useEffect, useRef } from 'react'\n\nexport interface Opts {\n  onFileChoosen(file: File, by: 'fs' | 'paste' | 'drop'): unknown\n}\n\nexport const useFileChooser = ({ onFileChoosen: fileChoosen }: Opts): [() => unknown] => {\n  const inputRef = useRef<HTMLInputElement | null>(null)\n  const chooseFile = useCallback(() => inputRef.current && inputRef.current.click(), [])\n  useEffect(() => {\n    const input = document.createElement('input')\n    input.setAttribute('type', 'file')\n    input.style.display = 'none'\n    const changeListener = () => {\n      const file = input.files && input.files.length > 0 && input.files[0]\n      if (!file) {\n        return\n      }\n      fileChoosen(file, 'fs')\n    }\n    input.addEventListener('change', changeListener)\n    document.body.appendChild(input)\n    inputRef.current = input\n    return () => {\n      input.removeEventListener('change', changeListener)\n      document.body.removeChild(input)\n      inputRef.current = null\n    }\n  }, [fileChoosen])\n\n  useEffect(() => {\n    const pasteListener = (pasteEv: ClipboardEvent) => {\n      const data = pasteEv.clipboardData\n      if (!(data && data.files && data.files.length > 0)) {\n        return\n      }\n      const file = data.files[0]\n      fileChoosen(file, 'paste')\n    }\n    document.body.addEventListener('paste', pasteListener)\n    return () => {\n      document.body.removeEventListener('paste', pasteListener)\n    }\n  }, [fileChoosen])\n\n  useEffect(() => {\n    const dropListener = (dragEv: DragEvent) => {\n      const data = dragEv.dataTransfer\n      if (!(data && data.files.length > 0)) {\n        return\n      }\n      const file = data.files[0]\n      fileChoosen(file, 'paste')\n    }\n    document.body.addEventListener('drop', dropListener)\n    return () => {\n      document.body.removeEventListener('drop', dropListener)\n    }\n  }, [fileChoosen])\n\n  return [chooseFile]\n}\n","import { fabric } from 'fabric'\nimport throttle from 'lodash/throttle'\nimport React, { createContext, SFC, useContext, useEffect, useMemo, useRef, useState } from 'react'\n\nexport interface FabricCanvasCtx {\n  setCanvas(canvas: fabric.Canvas): unknown\n}\nconst FabricCanvasCtx = createContext<FabricCanvasCtx>({} as FabricCanvasCtx)\n\nexport interface FabricCanvasCtrl {\n  setBackground(url: string): unknown\n  addSticker(url: string): unknown\n}\nconst FabricCanvasCtrl = createContext<FabricCanvasCtrl | null>(null)\n\nexport interface FabricCanvasCtxProvider {\n  setState(_: string): unknown\n}\nexport const FabricCanvasCtxProvider: SFC<FabricCanvasCtxProvider> = ({ children, setState }) => {\n  const [canvas, setCanvas] = useState<fabric.Canvas | null>(null)\n  const ctl = useMemo<FabricCanvasCtrl | null>(() => {\n    if (!canvas) {\n      return null\n    }\n    const setBackground = (url: string) => {\n      fabric.Image.fromURL(url, (img) => {\n        canvas.setBackgroundImage(img, () => {\n          resizeCanvas(canvas)\n          setState(canvas.toDatalessJSON())\n        })\n      })\n    }\n    const addSticker = (url: string) => {\n      fabric.Image.fromURL(url, (img) => {\n        img.scaleToWidth(window.innerWidth / 5)\n        canvas.add(img)\n        resizeCanvas(canvas)\n        setState(canvas.toDatalessJSON())\n      })\n    }\n    return {\n      setBackground,\n      addSticker\n    }\n  }, [canvas, setState])\n  const ctx = useMemo(() => {\n    return { setCanvas }\n  }, [])\n  return (\n    <FabricCanvasCtx.Provider value={ctx}>\n      <FabricCanvasCtrl.Provider value={ctl}>{children}</FabricCanvasCtrl.Provider>\n    </FabricCanvasCtx.Provider>\n  )\n}\nexport const useCanvasCtrl = () => {\n  return useContext(FabricCanvasCtrl)\n}\nconst resizeCanvas = (canvas: fabric.Canvas) => {\n  if (!canvas) {\n    return\n  }\n\n  const dim = {\n    height: window.innerHeight - 20,\n    width: window.innerWidth\n  }\n  canvas.setDimensions(dim)\n\n  const bgImg = canvas.backgroundImage\n  if ('undefined' === typeof bgImg) {\n    canvas.setZoom(1)\n    canvas.renderAll()\n  } else if (bgImg instanceof fabric.Image) {\n    setZoom(bgImg)\n  } else {\n    fabric.Image.fromURL(bgImg, setZoom)\n  }\n\n  function setZoom(bgImage: fabric.Image) {\n    const zoom = Math.min(dim.height / (bgImage.height || 1), dim.width / (bgImage.width || 1))\n    canvas.setZoom(zoom)\n    canvas.renderAll()\n  }\n}\n\nexport interface FabricCanvas {\n  opts?: fabric.ICanvasOptions\n}\n\nconst canvasOpts: fabric.ICanvasOptions = {\n  interactive: true\n}\nexport const FabricCanvas: SFC<FabricCanvas> = ({ opts }) => {\n  const ctx = useContext(FabricCanvasCtx)\n\n  const canvasRef = useRef<fabric.Canvas>()\n\n  useEffect(() => {\n    // resize on init\n    const resizeHandler = throttle(\n      () => {\n        if (!canvasRef.current) {\n          return\n        }\n        resizeCanvas(canvasRef.current)\n      },\n      10,\n      { trailing: true }\n    )\n    window.addEventListener('resize', resizeHandler, false)\n    return () => {\n      window.removeEventListener('resize', resizeHandler, false)\n    }\n  }, [])\n  const ref = useRef<HTMLCanvasElement>(null)\n  useEffect(() => {\n    if (canvasRef.current) {\n      return\n    }\n    const canvasElem = ref.current\n    if (canvasElem) {\n      canvasRef.current = new fabric.Canvas(canvasElem, { ...canvasOpts, ...opts })\n      resizeCanvas(canvasRef.current)\n      ctx.setCanvas(canvasRef.current)\n    }\n  }, [ctx, opts])\n  return <canvas ref={ref}></canvas>\n}\n","import { useCallback, useState } from 'react'\n\nexport const useBoolState = (initial: boolean) => {\n  let [state, setState] = useState(false)\n  const toFalse = useCallback(() => setState(false), [])\n  const toTrue = useCallback(() => setState(true), [])\n  const toggle = useCallback(() => setState(!state), [state])\n  return { b: state, T: toTrue, F: toFalse, t: toggle, s: setState }\n}\n","import React, { SFC, useCallback, useMemo } from 'react'\nimport { ImageMeta } from '../../../srv/db'\nimport { AddStickerButton } from '../../../ui/modules/top-bar/AddStickerButton'\nimport { ImportedImageGalleryHOC } from '../importedImageGallery/ImportedImageGalleryHOC'\nimport { useCanvasCtrl } from '../../../srv/fabric/canvas'\nimport { useBoolState } from '../../../lib/hook/useBoolState'\n\nexport const AddStickerButtonHoc: SFC = () => {\n  const { b: isModalOpen, T: openModal, F: closeModal } = useBoolState(false)\n  const mainCanvasCtrl = useCanvasCtrl()\n  const imageSelected = useCallback(\n    (meta: ImageMeta) => {\n      mainCanvasCtrl?.addSticker(meta.src)\n      closeModal()\n    },\n    [closeModal, mainCanvasCtrl]\n  )\n\n  const Gallery = useMemo(() => <ImportedImageGalleryHOC onClickImage={imageSelected} />, [\n    imageSelected\n  ])\n\n  return (\n    <AddStickerButton\n      closeModal={closeModal}\n      isModalOpen={isModalOpen}\n      openModal={openModal}\n      Gallery={Gallery}\n    />\n  )\n}\n","import React, { SFC } from 'react'\nimport { TopBarButton } from '../../elements/top-bar/Button'\nimport { Modal } from '../Modal/Modal'\n\nexport interface SetBgButton {\n  isModalOpen: boolean\n  openModal(): unknown\n  closeModal(): unknown\n  Gallery: JSX.Element\n}\n\nexport const SetBgButton: SFC<SetBgButton> = ({ closeModal, isModalOpen, openModal, Gallery }) => {\n  return (\n    <>\n      <TopBarButton onClick={openModal}>Sfondo</TopBarButton>\n      {isModalOpen && <Modal onClickOut={closeModal}>{Gallery}</Modal>}\n    </>\n  )\n}\n","import React, { SFC, useCallback, useMemo } from 'react'\nimport { useBoolState } from '../../../lib/hook/useBoolState'\nimport { ImageMeta } from '../../../srv/db'\nimport { SetBgButton } from '../../../ui/modules/top-bar/SetBgButton'\nimport { ImportedImageGalleryHOC } from '../importedImageGallery/ImportedImageGalleryHOC'\nimport { useCanvasCtrl } from '../../../srv/fabric/canvas'\n\nexport const SetBgButtonHoc: SFC = () => {\n  const { b: isModalOpen, T: openModal, F: closeModal } = useBoolState(false)\n  const mainCanvasCtrl = useCanvasCtrl()\n  const imageSelected = useCallback(\n    (meta: ImageMeta) => {\n      mainCanvasCtrl?.setBackground(meta.src)\n      closeModal()\n    },\n    [closeModal, mainCanvasCtrl]\n  )\n  const Gallery = useMemo(() => <ImportedImageGalleryHOC onClickImage={imageSelected} />, [\n    imageSelected\n  ])\n\n  return (\n    <SetBgButton\n      closeModal={closeModal}\n      isModalOpen={isModalOpen}\n      openModal={openModal}\n      Gallery={Gallery}\n    />\n  )\n}\n","import React, { CSSProperties, SFC } from 'react'\nimport { FabricCanvas } from '../../srv/fabric/canvas'\n\nexport const MainCanvasHoc: SFC = () => {\n  return (\n    <div style={mainCanvasStyle}>\n      <FabricCanvas></FabricCanvas>\n    </div>\n  )\n}\n\nconst mainCanvasStyle: CSSProperties = {\n  // position: 'absolute',\n  // top: 0,\n  // bottom: 0,\n  // left: 0,\n  // right: 0\n}\n","import { PrjReducer, ProjectState } from './types'\nimport { setter } from '../../lib/utils'\ntype S = ProjectState\n\nexport const reducer: PrjReducer = (prev, action) => {\n  const next = _reducer(prev, action)\n  return next\n}\nconst _reducer: PrjReducer = (prev, action) => {\n  switch (action.t) {\n    case 'bg': {\n      return setBackground(prev, action.p)\n    }\n  }\n  return prev\n}\n\nexport const setBackground = setter<S, 'background'>('background')\n","import React, { useReducer, createContext, SFC, useContext } from 'react'\nimport { PrjReducer, ProjectState, Actions } from './types'\nimport { reducer } from './reducer'\n\nconst initialState: ProjectState = {\n  background: null // '/_/images/1/xoxo.png'\n}\nexport type ProjectStateCtx = { state: ProjectState; dispatch: React.Dispatch<Actions> }\nexport const ProjectStateCtx = createContext<ProjectStateCtx>({} as ProjectStateCtx)\nexport const useProjectState = () => useContext(ProjectStateCtx)\n\nexport interface Provide {}\nexport const ProvideProjectState: SFC<Provide> = ({ children }) => {\n  const [state, dispatch] = useReducer<PrjReducer>(reducer, initialState)\n  const value = { state, dispatch }\n  return <ProjectStateCtx.Provider value={value}>{children}</ProjectStateCtx.Provider>\n}\n","import React from 'react'\nimport ReactDOM from 'react-dom'\nimport './index.css'\nimport { App } from './hoc/App'\nimport { GlobCtx } from './ctx/globs'\n// import { defineCustomElements } from '@ionic/pwa-elements/loader'\n// import * as serviceWorker from './serviceWorker'\n\nReactDOM.render(\n  <GlobCtx>\n    <App />\n  </GlobCtx>,\n  document.getElementById('root')\n)\n\n// defineCustomElements(window)\n\n// If you want your app to work offline and load faster, you can change\n// unregister() to register() below. Note this comes with some pitfalls.\n// Learn more about service workers: https://bit.ly/CRA-PWA\n// serviceWorker.unregister();\n//serviceWorker.register()\nnavigator.serviceWorker.register('sw.js')\n","import React, { SFC } from 'react'\nimport { ProvideProjectState } from '../state/project'\n\nexport const GlobCtx: SFC = ({ children }) => {\n  return <ProvideProjectState>{children}</ProvideProjectState>\n}\n","import React, { SFC, useMemo } from 'react'\nimport { MainTpl } from '../ui/templates/Main'\nimport * as topBar from './modules/top-bar/'\nimport { MainCanvasHoc } from './canvas/MainCanvasHoc'\nimport { FabricCanvasCtxProvider } from '../srv/fabric/canvas'\n\nexport const App: SFC = () => {\n  const mainProps = useMemo<MainTpl>(() => {\n    return {\n      TopBar: (\n        <>\n          <topBar.SetBgButtonHoc />\n          <topBar.AddStickerButtonHoc />\n        </>\n      ),\n      Canvas: <MainCanvasHoc />\n    }\n  }, [])\n\n  return (\n    <FabricCanvasCtxProvider setState={console.log}>\n      <MainTpl {...mainProps}></MainTpl>\n    </FabricCanvasCtxProvider>\n  )\n}\n"],"sourceRoot":""}